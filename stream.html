<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1c1c1c">
  <title>Stream</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script defer='91910' src='//api.linkshortify.com/verify.js'></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FDTG7GYCM9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-FDTG7GYCM9');
</script>
<style>
  /* existing styles remain unchanged */
</style>
</head>
<body>
<canvas id="particles-bg"></canvas>
<br><br><br><br>
<div class="button-wrapper">
  <a href="index.html" class="back-home-btn">Back</a>
</div>

<div id="verificationLock" class="verify-lock" style="display: none;">
  <h2>Verification Required</h2>
  <p>Please verify once to unlock access to all videos for the next 24 hours.</p>
  <button class="verify-btn" onclick="startVerification()">Verify Now</button>
</div>

<div class="card" id="streamCard" style="display: none;">
  <div class="title" id="videoTitle">Streaming...</div>
  <div id="loader" class="loading"><div class="spinner"></div></div>
  <div class="iframe-container" id="videoContainer" style="display: none;">
    <iframe id="videoPlayer" allowfullscreen></iframe>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const streamUrl = urlParams.get('url');
  const title = urlParams.get('title') || "Streaming...";

  function readFromIndexedDB(key) {
    return new Promise((resolve) => {
      const request = indexedDB.open('AppData', 1);
      request.onsuccess = function(e) {
        const db = e.target.result;
        const tx = db.transaction('store', 'readonly');
        const store = tx.objectStore('store');
        const getRequest = store.get(key);
        getRequest.onsuccess = () => resolve(getRequest.result || 0);
        getRequest.onerror = () => resolve(0);
      };
      request.onerror = () => resolve(0);
      request.onupgradeneeded = function (e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('store')) {
          db.createObjectStore('store');
        }
      };
    });
  }

  async function isVerified() {
    const local = parseInt(localStorage.getItem('verifiedUntil') || '0', 10);
    if (local > Date.now()) return true;

    const fallback = await readFromIndexedDB('verified_until');
    return fallback > Date.now();
  }

  const streamCard = document.getElementById("streamCard");
  const verificationLock = document.getElementById("verificationLock");

  isVerified().then(verified => {
    if (verified) {
      showStream();
    } else {
      verificationLock.style.display = "block";
    }
  });

  function showStream() {
    verificationLock.style.display = "none";
    streamCard.style.display = "block";
    document.getElementById("videoTitle").innerText = decodeURIComponent(title);

    if (!streamUrl) {
      document.getElementById('loader').innerText = "No video URL provided.";
      return;
    }

    const iframe = document.getElementById('videoPlayer');
    iframe.src = streamUrl;
    iframe.onload = () => {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('videoContainer').style.display = 'block';
    };
  }

  function startVerification() {
    const currentUrl = encodeURIComponent(window.location.href);
    const apiToken = '5f48fcdb492e4753beed763bed31181deb9cf091';
    const apiUrl = `https://linkshortify.com/api?api=${apiToken}&url=${currentUrl}`;
    fetch(apiUrl)
      .then(res => res.json())
      .then(result => {
        if (result.status === 'error') {
          alert(result.message);
          return;
        }
        window.location.href = result.shortenedUrl;
      })
      .catch(() => alert("Failed to generate ad link."));
  }

  // Particle animation remains unchanged
</script>
</body>
</html>
